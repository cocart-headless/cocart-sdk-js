# Cart Key Handling in CoCart SDK

## Table of Contents

- [Overview](#overview)
- [Cart Key Lifecycle](#cart-key-lifecycle)
- [Authentication State](#authentication-state)
- [Examples](#examples)

## Overview

The CoCart SDK manages cart keys automatically through HTTP headers and SDK state. This includes:

- Automatic extraction of cart keys from API responses
- Management of cart key state during authentication
- Handling cart session transfers between guest and authenticated states

## Cart Key Lifecycle

### Headers

The SDK processes these cart-related headers:
- `CoCart-API-Cart-Key`: The cart session identifier
- `CoCart-API-Cart-Expiring`: Time in seconds until cart starts expiring
- `CoCart-API-Cart-Expiration`: Time in seconds until cart fully expires

### State Management

Cart key state follows these rules:
1. For guest sessions:
   - Cart key is stored in SDK state
   - Key is included in subsequent requests
   - Expiration times are tracked

2. For authenticated sessions:
   - Cart key is cleared after successful authentication
   - API handles session transfer automatically
   - Further requests use authentication credentials only

## Authentication State

When authentication changes:

1. Guest cart to authenticated:
   - Last used cart key is included in first authenticated request
   - API transfers cart contents to authenticated session
   - Cart key is cleared from SDK state
   - Further requests use only authentication

2. Authenticated to guest:
   - New cart key is generated by API
   - SDK stores new cart key for guest session

## Examples

### Monitoring Cart State Changes

```javascript
// Start as guest
const cart = await cocart.cart.create();
await cocart.cart.addItem(123); // Uses cart key

// Authenticate
cocart.setAuth({
  type: 'basic',
  username: 'user',
  password: 'pass'
});

// First authenticated request transfers cart automatically
await cocart.cart.getCart(); // Cart contents preserved, now in authenticated session

// Later, logout
cocart.setAuth({ type: 'none' });
// Next cart operation will create new guest cart
